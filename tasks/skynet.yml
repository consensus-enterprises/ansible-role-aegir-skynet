---

- name: Ensure that hosting-queued service is stopped and disabled.
  service:
    name: hosting-queued
    state: stopped
    enabled: no
  become: yes

- name: Enable Skynet module
  include_role:
    name: consensus.aegir
    tasks_from: extra-module.yml
  vars:
    aegir_extra_module: hosting_skynet

- name: Ensure handlers don't run while the following tasks execute asyncronously.
  meta: flush_handlers

- name: Drain task queue in preparation of starting Skynet.
  shell: drush @hostmaster hosting-tasks
  become: yes
  become_user: "{{ aegir_user }}"
  when: (aegir_extra_module_enabled.rc is defined) and (aegir_extra_module_enabled.rc != 0)

- name: Verify the Aegir front-end to ensure Skynet config file is generated.
  shell: drush @hostmaster hosting-task @hostmaster verify && drush @hostmaster hosting-tasks
  become: yes
  become_user: "{{ aegir_user }}"
  when: (aegir_extra_module_enabled.rc is defined) and (aegir_extra_module_enabled.rc != 0)

- name: Wait until the Skynet script is deployed.
  wait_for:
    path: "{{ aegir_root }}/config/skynet/skynet.py"
  when: (aegir_extra_module_enabled.rc is defined) and (aegir_extra_module_enabled.rc != 0)

# app-armour.yml
- name: Copy Skynet script to alternate path (if required).
  copy:
    src: "{{ skynet_default_bin_path }}"
    dest: "{{ skynet_bin_path }}"
    force: yes          # Script may be updated with newer Hostmaster platforms.
    local_follow: yes   # Script is symlinked from the Hostmaster platform.
    remote_src: yes     # Script is deployed by the hosting_skynet module.
    mode: 0755
  become: yes
  when: skynet_bin_path != skynet_default_bin_path

# supervisor-config.yml
- name: Add Skynet Supervisor config
  template:
    src: skynet-queue.conf.j2
    dest: /etc/supervisor/conf.d/skynet-queue.conf
  register: skynet_supervisor_config
  become: yes

# supervisor-service.yml
- name: Ensure Supervisor service is running
  service:
    name: supervisor
    enabled: yes
    state: started
  become: yes

- name: Reload Supervisor if config changed
  command: supervisorctl reload
  become: yes
  when: skynet_supervisor_config.changed |bool

- name: Start Skynet via Supervisor
  supervisorctl:
    name: skynet-queue
    state: started
  become: yes
